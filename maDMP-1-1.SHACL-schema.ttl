@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix :      <https://w3id.org/madmp/terms#> .
@prefix schema: <http://schema.org/> .
@prefix owl:   <http://www.w3.org/2002/07/owl#> .
@prefix ns:    <http://www.w3.org/2003/06/sw-vocab-status/ns#> .
@prefix dcam:  <http://purl.org/dc/dcam/> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix skos:  <http://www.w3.org/2004/02/skos/core#> .
@prefix dcsx:  <https://w3id.org/dcso/ns/extension#> .
@prefix rdfs:  <http://www.w3.org/2000/01/rdf-schema#> .
@prefix ex:    <https://w3id.org/dcso/id/example/> .
@prefix dct:   <http://purl.org/dc/terms/> .
@prefix rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix terms: <http://purl.org/dc/terms/> .
@prefix xml:   <http://www.w3.org/XML/1998/namespace> .
@prefix dcat:  <http://www.w3.org/ns/dcat#> .
@prefix vann:  <http://purl.org/vocab/vann/> .
@prefix wot:   <http://xmlns.com/wot/0.1/> .
@prefix prov:  <http://www.w3.org/ns/prov#> .
@prefix madmp: <https://w3id.org/madmp/terms#> .
@prefix foaf:  <http://xmlns.com/foaf/0.1/> .
@prefix dash: <http://datashapes.org/dash#> .

ex:DMPShape
    a sh:NodeShape;
    sh:name "The DMP Schema";
    sh:targetClass madmp:DMP;
    sh:property [
        sh:path terms:title;
        sh:name "The DMP Title Schema";
        sh:description "Title of a DMP";
        sh:minCount 1;
        sh:maxCount 1;
        sh:datatype xsd:string;
    ];
    sh:property [
        sh:path madmp:contact;
        sh:name "The DMP Contact Schema";
        sh:minCount 1;
        sh:maxCount 1;
        sh:property [
            sh:path madmp:contact_id;
            sh:name "The Contact ID Schema";
            sh:minCount 1;
            sh:maxCount 1;
            sh:property [
                sh:path terms:identifier;
                sh:name "The DMP Contact Identifier Schema";
                sh:minCount 1;
                sh:maxCount 1;
                sh:datatype xsd:string;
            ];
            sh:property [
                sh:path madmp:identifier_type;
                sh:name "The DMP Contact Identifier Type Schema";
                sh:description "Identifier type. Allowed values: orcid, isni, openid, other";
                sh:minCount 1;
                sh:maxCount 1;
                sh:in ("orcid"^^xsd:string "isni"^^xsd:string "openid"^^xsd:string "other"^^xsd:string);
            ];
        ];
        sh:property [
            sh:path foaf:mbox;
            sh:name "The Mailbox Schema";
            sh:description "Contact Person's E-mail address";
            sh:minCount 1;
            sh:maxCount 1;
            sh:pattern "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
        ];
        sh:property [
            sh:path foaf:name;
            sh:name "The Name Schema";
            sh:description "Name of the contact person";
            sh:minCount 1;
            sh:maxCount 1;
            sh:datatype xsd:string;
        ];

    ];
    sh:property [
        sh:path madmp:contributor;
        sh:name "The Contributor Schema";
        sh:property [
            sh:path madmp:contributor_id;
            sh:name "The Contributor_id Schema";
            sh:minCount 1;
            sh:maxCount 1;
            sh:property [
                sh:path terms:identifier;
                sh:name "The Contributor Identifier Schema";
                sh:description "Identifier for a contact person";
                sh:minCount 1;
                sh:maxCount 1;
                sh:datatype xsd:string;
            ];
            sh:property [
                sh:path madmp:identifier_type;
                sh:name "The Contributor Identifier Type Schema";
                sh:description "Identifier type. Allowed values: orcid, isni, openid, other";
                sh:minCount 1;
                sh:maxCount 1;
                sh:in ("orcid"^^xsd:string "isni"^^xsd:string "openid"^^xsd:string "other"^^xsd:string);
            ];
        ];
        sh:property [
            sh:path foaf:mbox;
            sh:name "The Contributor Mailbox Schema";
            sh:description "Contributor Mail address";
            sh:maxCount 1;
            sh:pattern "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
        ];
        sh:property [
            sh:path foaf:name;
            sh:name "The Name Schema";
            sh:description "Name of the contributor";
            sh:minCount 1;
            sh:maxCount 1;
            sh:datatype xsd:string;
        ];
        sh:property [
            sh:path madmp:role;
            sh:name "The Role Schema";
            sh:description "Type of contributor";
            sh:node dash:ListShape;
            sh:minCount 1 ;
            sh:property [
                sh:path ( [ sh:zeroOrMorePath rdf:rest ] rdf:first ) ;
                sh:datatype xsd:string ;
                sh:minCount 1 ;
            ]
        ];
        sh:sparql [
            sh:message "Contributor {?name} has role {?role} more than once ({?roleCount} times).";
            sh:prefixes (madmp: rdf: foaf:);
            sh:select """
            PREFIX madmp: <https://w3id.org/madmp/terms#>
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            prefix foaf:  <http://xmlns.com/foaf/0.1/>

            SELECT $this ?role ?name (COUNT(?role) AS ?roleCount)
            WHERE {
                $this $PATH ?contributor.
                ?contributor madmp:role/rdf:rest*/rdf:first ?role;
                foaf:name ?name
            }
            GROUP BY $this ?name ?role
            HAVING (?roleCount > 1)
            """
        ]
    ];
    sh:property [
        sh:path terms:title;
        sh:name "The DMP Title Schema";
        sh:description "Title of a DMP";
        sh:minCount 1;
        sh:maxCount 1;
        sh:datatype xsd:string;
    ].